<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Trip - TravelBank</title>
    <script type="module" src="/tripapp/scripts/js/main.js"></script>
    <link rel="stylesheet" type="text/css" href="/tripapp/scripts/css/main.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; padding: 20px; }
        .trip-container { max-width: 700px; margin: auto; padding: 20px; }
        .input-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        .hidden-file-input { display: none; }
        .upload-preview { cursor: pointer; text-align: center; padding: 10px; border: 1px dashed #ddd; }
        .media-preview img, .media-preview video { width: 100%; margin-top: 10px; border-radius: 5px; }
        .save-btn { background-color: #007bff; color: white; padding: 10px; border: none; cursor: pointer; }
        .save-btn:hover { background-color: #0056b3; }

        #post-container {
    max-width: 600px;
    margin: auto;
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
}

#post-box {
    display: flex;
    flex-direction: column;
    gap: 10px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

#post-content {
    width: 100%;
    height: 80px;
    border: none;
    border-radius: 5px;
    padding: 10px;
    resize: none;
    font-size: 14px;
}

#post-media {
    font-size: 12px;
}

button {
    padding: 10px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

button:hover {
    background: #0056b3;
}

.post {
    background: #fff;
    margin-top: 15px;
    padding: 15px;
    border-radius: 10px;
    box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
}

.post p {
    font-size: 14px;
}

.post .post-controls {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}

.vote-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
}

.vote-btn.upvoted {
    color: green;
}

.vote-btn.downvoted {
    color: red;
}

.pinned {
    border-left: 5px solid gold;
    background-color: #fffbe6;
}

/* Style for buttons */
.btn-toggle, .btn-add-option, .btn-post {
    background-color: #4CAF50;
    border: none;
    color: white;
    padding: 12px 24px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s, transform 0.3s;
    border-radius: 8px;
    margin: 5px;
}

.btn-toggle:hover, .btn-add-option:hover, .btn-post:hover {
    background-color: #45a049;
    transform: scale(1.05);
}

.file-upload-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.poll-section {
    display: block;
}

#poll-options {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}

.poll-option {
    padding: 8px;
    width: 100%;
    font-size: 14px;
    border-radius: 5px;
    border: 1px solid #ccc;
}

#addPollOption {
    background-color: #f44336;
    font-size: 16px;
    padding: 8px 16px;
}

#addPollOption:hover {
    background-color: #e53935;
}

#poll-section, .file-upload-container {
    display: block;
}

/* Hide sections initially */
#poll-section.hidden, .file-upload-container.hidden {
    display: none;
    pointer-events: none;
}

#post-options {
    display: flex;
}

#post-media {
    display: none;
}

#media-preview {
    display: flex;
    flex-wrap: wrap;
    margin-top: 10px;
    gap: 10px;
    border: 1px dashed #ccc;
    padding: 10px;
    border-radius: 5px;
}

#media-preview img, #media-preview video {
    width: 100px;
    height: auto;
    border-radius: 5px;
    margin: 5px;
}

.preview-container {
    position: relative;
    display: inline-block;
}

.remove-btn {
    position: absolute;
    top: 0;
    right: 0;
    background: rgba(255, 0, 0, 0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 12px;
    cursor: pointer;
}

.collage-container {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
}

.collage-image {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 5px;
}

.view-others {
    text-align: right;
    margin-top: 5px;
}

.view-others-btn {
    background-color: #0078ff;
    color: white;
    padding: 5px 10px;
    border: none;
    cursor: pointer;
}

.view-others-btn:hover {
    background-color: #005bb5;
}


    /* Image Viewer Styles */
    .image-viewer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .image-viewer img {
        max-width: 90%;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2);
        transition: opacity 0.3s ease-in-out;
    }

    .image-viewer .controls {
        position: absolute;
        bottom: 20px;
        display: flex;
        gap: 10px;
    }

    .image-viewer button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 10px 15px;
        font-size: 18px;
        cursor: pointer;
        border-radius: 5px;
        transition: background 0.3s;
    }

    .image-viewer button:hover {
        background: rgba(255, 255, 255, 0.4);
    }

    .close-btn {
        position: absolute;
        top: 15px;
        right: 20px;
        font-size: 24px;
        background: rgba(255, 255, 255, 0.3);
        padding: 5px 10px;
        border-radius: 50%;
    }

    .prev-btn, .next-btn {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        padding: 10px;
    }

    .prev-btn {
        left: 20px;
    }

    .next-btn {
        right: 20px;
    }
    </style>
</head>
<body>
    <header id="dynamicHeader"></header>
    <main id="mainContainer">

        <div class="trip-navigation">
            <button id="btnView" class="trip-tab active">View</button>
            <button id="btnItinerary" class="trip-tab">Itinerary</button>
            <button id="btnEdit" class="trip-tab">Edit</button>
            <button id="btnSettings" class="trip-tab">Settings</button>
            <button id="btnInvites" class="trip-tab">Invites</button>
            <button id="btnMedia" class="trip-tab">Media</button>
            <button id="btnContributors" class="trip-tab">Contributors</button>
        </div>
        
   
<section id="settings_trip" class="trip-section hidden">Settings Content Here
                              <!-- Voting Settings -->
                              <h3>Voting</h3>
                              <p id="viewVotingStatus">Voting is <strong>enabled</strong></p>
               
</section>
<section id="contributors_trip" class="trip-section hidden">Contributors Content Here

           
                <!-- Contributors -->
                <h3>Contributors</h3>
                <ul id="viewContributorsList">
                    <li>Elaine Wilson</li>
                    <li>Raquita Wilson</li>
                </ul>
</section>
<section id="media_trip" class="trip-section hidden">Media Content Here</section>
        


           <!-- View Itinerary -->
           <section id="view_itinerary" class="trip-section hidden">
            <h3>View Itinerary</h3>
            <div class="trip-container">
        
                <!-- Media Upload -->
                <h3>Uploaded Media</h3>
                <div class="media-preview" id="viewMediaPreview">
                    <img src="example-photo.jpg" alt="Trip Photo">
                </div>


                <!-- Invite & Sharing -->
                <h3>Invite & Sharing</h3>
                <p><strong>Share This Trip:</strong> <input type="text" id="viewJoinTripLink" value="https://triplink.com/paris-trip" readonly>
                    <button id="copyJoinLinkBtn">Copy</button>
                </p>

                <!-- Trip Title -->
                <h3 id="viewTripTitle">Trip to Paris</h3>
                <p id="viewTripDescription">An exciting getaway to Paris, exploring famous landmarks and local cuisine.</p>
        
                <!-- Start & End Date -->
                <p><strong>Dates:</strong> <span id="viewTripStartDate">April 8, 2025</span> - <span id="viewTripEndDate">April 14, 2025</span></p>
        
                <!-- Location -->
                <p><strong>Destination:</strong> <span id="viewTripLocation">Paris, France</span></p>
                <p><strong>Google Maps:</strong> <a id="viewTripMapLink" href="#" target="_blank">View on Map</a></p>
        
                <!-- Flight Info -->
                <h3>Flight Information</h3>
                <p><strong>Airport:</strong> <span id="viewFlightAirport">DFW</span></p>
                <p><strong>Airline:</strong> <span id="viewFlightAirline">American Airlines</span></p>
                <p><strong>Flight Number:</strong> <span id="viewFlightNumber">NEQBFF</span></p>
                <p><strong>Departure:</strong> <span id="viewFlightDeparture">April 8, 2025, 10:30 AM</span></p>
                <p><strong>Arrival:</strong> <span id="viewFlightArrival">April 8, 2025, 4:30 PM</span></p>
                <div id="viewFlightsContainer">
                <!-- View Flight -->
            </div>

                <!-- Hotel/Stay Info -->
                <h3>Hotel / Stay Information</h3>
                <p><strong>Hotel:</strong> <span id="viewHotelName">Merveil - Luxury Suite</span></p>
                <p><strong>Check-in:</strong> <span id="viewHotelCheckIn">April 8, 2025</span></p>
                <p><strong>Check-out:</strong> <span id="viewHotelCheckOut">April 14, 2025</span></p>
                <p><strong>Booking Details:</strong> <span id="viewHotelBookingDetails">Confirmed - Booking #123456</span></p>
                <div id="viewHotelsContainer">
                    <!-- View Stay -->
                </div>

<!-- Events & Itinerary -->
<h3>Events & Itinerary</h3>
<ul id="viewEventList">
    <li>Eiffel Tower Visit - April 9</li>
    <li>Seine River Cruise - April 10</li>
    <li>Food Tour - April 11</li>
</ul>



        
                <!-- Notes -->
                <h3>Notes</h3>
                <p id="viewTripNotes">Don’t forget to try the croissants at Le Grenier à Pain!</p>
        

        
            </div>

            

        
     </section>

     <section id="view_trip" class="trip-section">
        <div id="trip-info">
            <h2>Your Trip Details</h2>
            <h3 id="tripTitle">Trip Name</h3>
            <h3 id="tripDate">Trip Date</h3>
        </div>
        <div id="post-container">
            <!-- Post Input Section -->
            <div id="post-box">
                <textarea id="post-content" placeholder="Share something about this trip..."></textarea>
               
               
               
                <div id="media-container" class="file-upload-container" style="display: block;">
                    <div>
                        <input type="file" id="post-media" accept="image/*,video/*" multiple style="display: none;" />
                    </div>
                    
                    <div id="media-preview" style="display: none;">
                        <!-- Media previews will be displayed here -->
                    </div>
                    
                </div>
    
                <!-- Poll Option -->
                <div id="poll-section" class="poll-section hidden">
                    <input type="text" id="poll-question" placeholder="Add a poll question (optional)">
                    <div id="poll-options">
                        <input type="text" class="poll-option" placeholder="Option 1">
                        <input type="text" class="poll-option" placeholder="Option 2">
                    </div>
                    <button id="addPollOption" class="btn-add-option">+ Add Option</button>
                </div>
    <div id="post-options">
        <button id="media-btn" class="btn-media">Media</button>
        <button id="hide-poll-btn" class="btn-toggle">Hide Poll</button>
        <button id="addPost" class="btn-post">Post</button>

    </div>
            </div>
    
            <!-- Post List -->
            <div id="post-list-Area">Post Area</div>
            <div id="post-list"></div>
        </div>
    </section>
    
    
    

        
        </section>
        



        <section id="edit_trip" class="trip-section hidden">
        <h2>Edit Your Trip</h2>
            <div class="trip-container">
        
                <!-- Trip Title -->
                <div class="input-group">
                    <label for="tripEditTitle">Trip Title</label>
                    <input type="text" id="tripEditTitle" placeholder="Enter trip title">
                </div>
        
                <!-- Trip Description -->
                <div class="input-group">
                    <label for="tripDescription">Trip Description</label>
                    <textarea id="tripDescription" placeholder="Describe your trip..."></textarea>
                </div>
        
                <!-- Start & End Date -->
                <div class="input-group">
                    <label for="tripStartDate">Start Date</label>
                    <input type="date" id="tripStartDate">
                </div>
        
                <div class="input-group">
                    <label for="tripEndDate">End Date</label>
                    <input type="date" id="tripEndDate">
                </div>
        
                <!-- Location -->
                <div class="input-group">
                    <label for="tripLocation">Location</label>
                    <input type="text" id="tripLocation" placeholder="Destination (e.g., Paris, France)">
                </div>
                <div class="input-group">
                    <label for="tripMapLink">Google Maps Link</label>
                    <input type="url" id="tripMapLink" placeholder="Enter Google Maps link">
                </div>
        
                <!-- Flight Info -->
                <h3>Flight Information</h3>
                <div class="input-group">
                    <label for="flightAirline">Airline</label>
                    <input type="text" id="flightAirline" class="flightAirline" placeholder="Airline name">
                </div>
                <div class="input-group">
                    <label for="flightAirport">Airport</label>
                    <input type="text" class="destination" id="flightAirport" placeholder="Flight airport">
                </div>
                <div class="input-group">
                    <label for="flightNumber">Flight Number</label>
                    <input type="text" id="flightNumber" placeholder="Flight number">
                </div>
                <div class="input-group">
                    <label for="flightDeparture">Departure</label>
                    <input type="datetime-local" id="flightDeparture">
                </div>
                <div class="input-group">
                    <label for="flightArrival">Arrival</label>
                    <input type="datetime-local" id="flightArrival">
                </div>

                <div id="flightsContainer">
                    <button id="addFlight">+ Add Flight</button>
                </div>
        


                <!-- Hotel/Stay Info -->
                <h3>Hotel / Stay Information</h3>
                <div class="input-group">
                    <label for="hotelName">Hotel Name</label>
                    <input type="text" id="hotelName" class="hotelName" placeholder="Hotel or Airbnb name">
                </div>
                <div class="input-group">
                    <label for="hotelCheckIn">Check-in</label>
                    <input type="date" id="hotelCheckIn">
                </div>
                <div class="input-group">
                    <label for="hotelCheckOut">Check-out</label>
                    <input type="date" id="hotelCheckOut">
                </div>
                <div class="input-group">
                    <label for="hotelBookingDetails">Booking Details</label>
                    <textarea id="hotelBookingDetails" placeholder="Confirmation number, reservation details..."></textarea>
                </div>

                <div id="hotelsContainer">
                    <button id="addHotel">+ Add Hotel</button>
                </div>
        
         
<!-- Add Event Section -->
<div id="addEventSection">
    <h4>Add Event</h4>
    <input type="text" id="eventName" placeholder="Event Name" />
    <input type="text" id="eventInfo" placeholder="Event Info" />
    <input type="date" id="eventDate" />
    <button id="addEventBtn">Add Event</button>
</div>
                <!-- Notes -->
                <h3>Notes</h3>
                <div class="input-group">
                    <textarea id="tripNotes" placeholder="Add any notes about the trip..."></textarea>
                </div>
        
                <!-- Media Upload -->
                <h3>Upload Media</h3>
                <div class="input-group">
                    <label>Upload Photos/Videos</label>
                    <div class="upload-preview" onclick="document.getElementById('tripMedia').click()">Click to Upload</div>
                    <input type="file" id="tripMedia" class="hidden-file-input" accept="image/*,video/*">
                    <div class="media-preview" id="mediaPreview"></div>
                </div>
        

        
                <!-- Voting Settings -->
                <h3>Voting Settings</h3>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="enableVoting">
                        Allow others to vote on trip plans
                    </label>
                </div>
        
                <!-- Contributors -->
                <h3>Contributors</h3>
                <div id="contributorsList">
                    <button id="addContributor">+ Add Contributor</button>
                </div>
        
                <button class="save-btn" id="saveTrip">Save Changes</button>
        
            </div>
        </section>
        

    <section>
    <div id="shareTripLinkContainer" style="display: none; margin-top: 20px;">
        <label for="shareTripLinkText">Share This Trip:</label>
        <div class="input-group">
            <input type="text" id="shareTripLinkText" readonly>
            <button id="copyShareLinkBtn">Copy Link</button>
        </div>
    </div>
    </section>
    
    <section id="invites_trip" class="trip-section hidden">Invites Content Here
        <!-- Invite & Sharing -->
        <h3>Invite</h3>
        <div id="joinTripLinkContainer">
        <div class="input-group">
            <label for="joinTripLinkText">Trip Invite Link:</label>
            <div class="input-group">
                <input type="text" id="joinTripLinkText" readonly>
                <button id="copyJoinLinkBtn">Copy Link</button>
            </div>
        </div>
    </div>
        <div id="invite-list">
</div>

</section>


<!-- Image Viewer Modal -->
<div id="imageViewer" class="image-viewer">
    <button id="closeBtn" class="close-btn">✖</button>
    <img id="viewerImage" src="" alt="Image">
    <button id="prevBtn" class="prev-btn">◀</button>
    <button id="nextBtn" class="next-btn">▶</button>
</div>




</main>

<footer id="dynamicFooter"></footer>

    <script type="module">
        import {
            db, doc, getDoc, updateDoc,
    auth, deleteDoc,  userId, getStorage, ref, uploadBytes, 
    getDownloadURL, limit, arrayUnion, RecaptchaVerifier, increment,
     arrayRemove, signInWithPhoneNumber, query, setDoc, 
     addDoc, signInAnonymously, orderBy, onAuthStateChanged, 
     uploadBytesResumable, signInWithPopup, FacebookAuthProvider, 
     GoogleAuthProvider, startAfter, OAuthProvider, signOut,
      getFirestore, serverTimestamp,  userInfo,
createUserWithEmailAndPassword, signInWithEmailAndPassword, deleteObject,
where, getDocs, storage, getAuth, collection, analytics,EmailAuthProvider,
googleProvider,onSnapshot ,writeBatch ,batch, linkWithCredential,
facebookProvider, destinationAutoSuggest
        } from 'https://rw-501.github.io/tripapp/scripts/js/main.js';
    
        

        function getTripIdFromURL() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id');
        }





        const tripId = getTripIdFromURL();
        console.log("trip tripId: ",tripId);

        const tripEditTitle = document.getElementById("tripEditTitle");
        const tripTitle = document.getElementById("tripTitle");
        const tripDate = document.getElementById("tripDate");

        const tripDescription = document.getElementById("tripDescription");
const tripStartDate = document.getElementById("tripStartDate");
const tripEndDate = document.getElementById("tripEndDate");
const tripLocation = document.getElementById("tripLocation");
const tripMapLink = document.getElementById("tripMapLink");
const flightAirline = document.getElementById("flightAirline");
const flightAirport = document.getElementById("flightAirport");
const flightNumber = document.getElementById("flightNumber");
const flightDeparture = document.getElementById("flightDeparture");
const flightArrival = document.getElementById("flightArrival");
const hotelName = document.getElementById("hotelName");
const hotelCheckIn = document.getElementById("hotelCheckIn");
const hotelCheckOut = document.getElementById("hotelCheckOut");
const hotelBookingDetails = document.getElementById("hotelBookingDetails");
const tripNotes = document.getElementById("tripNotes");
const enableVoting = document.getElementById("enableVoting");

const flightsContainer = document.getElementById("flightsContainer");
const hotelsContainer = document.getElementById("hotelsContainer");
const addFlightBtn = document.getElementById("addFlight");
const addHotelBtn = document.getElementById("addHotel");

const eventList = document.getElementById("viewEventList");
    const eventNameInput = document.getElementById("eventName");
    const eventInfoInput = document.getElementById("eventInfo");
    const eventDateInput = document.getElementById("eventDate");
    const addEventBtn = document.getElementById("addEventBtn");


const tripMedia = document.getElementById("tripMedia");
const mediaPreview = document.getElementById("mediaPreview");
const saveTrip = document.getElementById("saveTrip");

const joinTripLinkContainer = document.getElementById("joinTripLinkContainer");
const joinTripLinkText = document.getElementById("joinTripLinkText");
const copyJoinLinkBtn = document.getElementById("copyJoinLinkBtn");

const shareTripLinkContainer = document.getElementById("shareTripLinkContainer");
const shareTripLinkText = document.getElementById("shareTripLinkText");
const copyShareLinkBtn = document.getElementById("copyShareLinkBtn");

const viewTripTitle = document.getElementById("viewTripTitle");
const viewTripDescription = document.getElementById("viewTripDescription");
const viewTripStartDate = document.getElementById("viewTripStartDate");
const viewTripEndDate = document.getElementById("viewTripEndDate");
const viewTripLocation = document.getElementById("viewTripLocation");
const viewTripMapLink = document.getElementById("viewTripMapLink");

const viewFlightAirline = document.getElementById("viewFlightAirline");
const viewFlightNumber = document.getElementById("viewFlightNumber");
const viewFlightAirport = document.getElementById("viewFlightAirport");
const viewFlightDeparture = document.getElementById("viewFlightDeparture");
const viewFlightArrival = document.getElementById("viewFlightArrival");

const viewHotelName = document.getElementById("viewHotelName");
const viewHotelCheckIn = document.getElementById("viewHotelCheckIn");
const viewHotelCheckOut = document.getElementById("viewHotelCheckOut");
const viewHotelBookingDetails = document.getElementById("viewHotelBookingDetails");

const viewTripNotes = document.getElementById("viewTripNotes");

const viewFlightsContainer = document.getElementById("viewFlightsContainer");
const viewHotelsContainer = document.getElementById("viewHotelsContainer");

const viewMediaPreview = document.getElementById("viewMediaPreview");





// Show/Hide Poll Section
const pollBtn = document.getElementById("hide-poll-btn");
const pollSection = document.getElementById("poll-section");

pollBtn.addEventListener("click", () => {
    pollSection.classList.toggle("hidden");
    pollBtn.textContent = pollSection.classList.contains("hidden") ? "Show Poll" : "Hide Poll";
});

// Add Poll Option
const addPollOptionBtn = document.getElementById("addPollOption");

addPollOptionBtn.addEventListener("click", () => {
    const pollOptionsDiv = document.getElementById("poll-options");
    const newPollOption = document.createElement("input");
    newPollOption.type = "text";
    newPollOption.className = "poll-option";
    newPollOption.placeholder = "New Option";
    pollOptionsDiv.appendChild(newPollOption);
});











// Function to create a new flight input set
function addFlight(flightData = {}) {
    const flightDiv = document.createElement("div");
    flightDiv.classList.add("flight-entry");
    flightDiv.innerHTML = `
        <div class="input-group">
            <label>Airline</label>
            <input type="text" class="flightAirline" placeholder="Airline name" value="${flightData.airline || ''}">
        </div>
        <div class="input-group">
           <label for="flightAirport">Airport</label>
           <input type="text" class="destination" id="flightAirport" placeholder="Flight airport">
        </div>
        <div class="input-group">
            <label>Flight Number</label>
            <input type="text" class="flightNumber" placeholder="Flight number" value="${flightData.flightNumber || ''}">
        </div>
        <div class="input-group">
            <label>Departure</label>
            <input type="datetime-local" class="flightDeparture" value="${flightData.departure || ''}">
        </div>
        <div class="input-group">
            <label>Arrival</label>
            <input type="datetime-local" class="flightArrival" value="${flightData.arrival || ''}">
        </div>
        <button class="remove-flight">Remove Flight</button>
    `;

    flightDiv.querySelector(".remove-flight").addEventListener("click", () => {
        flightDiv.remove();
    });

    flightsContainer.insertBefore(flightDiv, addFlightBtn);
    airlineAutoSuggest(".flightAirline");

}

// Function to create a new hotel input set
function addHotel(hotelData = {}) {
    const hotelDiv = document.createElement("div");
    hotelDiv.classList.add("hotel-entry");
    hotelDiv.innerHTML = `
        <div class="input-group">
            <label>Hotel Name</label>
            <input type="text" class="hotelName" placeholder="Hotel or Airbnb name" value="${hotelData.name || ''}">
        </div>
        <div class="input-group">
            <label>Check-in</label>
            <input type="date" class="hotelCheckIn" value="${hotelData.checkIn || ''}">
        </div>
        <div class="input-group">
            <label>Check-out</label>
            <input type="date" class="hotelCheckOut" value="${hotelData.checkOut || ''}">
        </div>
        <div class="input-group">
            <label>Booking Details</label>
            <textarea class="hotelBookingDetails" placeholder="Confirmation number, reservation details...">${hotelData.details || ''}</textarea>
        </div>
        <button class="remove-hotel">Remove Hotel</button>
    `;

    hotelDiv.querySelector(".remove-hotel").addEventListener("click", () => {
        hotelDiv.remove();
    });

    hotelsContainer.insertBefore(hotelDiv, addHotelBtn);
hotelAutoSuggest(".hotelName");
}

// Add event listeners for buttons
addFlightBtn.addEventListener("click", () => addFlight());
addHotelBtn.addEventListener("click", () => addHotel());


    // Function to add event to list dynamically
    function addEventToList(name, date, info) {
        const eventItem = document.createElement("li");
        eventItem.innerHTML = `<strong>${name}</strong> - ${date} (${info || "No additional info"}) 
                               <button class="deleteEventBtn">❌</button>`;

        eventList.appendChild(eventItem);

        // Delete event from Firebase and UI
        eventItem.querySelector(".deleteEventBtn").addEventListener("click", async function () {
            eventItem.remove();
            await deleteEvent(name, date);
        });
    }

    // Add new event and save to Firebase
    addEventBtn.addEventListener("click", async function () {
        const eventName = eventNameInput.value.trim();
        const eventInfo = eventInfoInput.value.trim();
        const eventDate = eventDateInput.value;

        if (!eventName || !eventDate) {
            showToast("Please enter at least an event name and date.");
            return;
        }

        const newEvent = { name: eventName, date: eventDate, info: eventInfo };
        addEventToList(eventName, eventDate, eventInfo); // Add to UI

        try {
            const tripSnap = await getDoc(tripRef);
            const tripData = tripSnap.exists() ? tripSnap.data() : {};
            const updatedEvents = [...(tripData.events || []), newEvent];

            await updateDoc(tripRef, { events: updatedEvents });

            // Clear input fields
            eventNameInput.value = "";
            eventInfoInput.value = "";
            eventDateInput.value = "";
        } catch (error) {
            console.error("Error saving event:", error);
        }
    });

    // Function to delete event from Firebase
    async function deleteEvent(eventName, eventDate) {
        try {
            const tripSnap = await getDoc(tripRef);
            if (tripSnap.exists()) {
                const tripData = tripSnap.data();
                const updatedEvents = (tripData.events || []).filter(event => !(event.name === eventName && event.date === eventDate));

                await updateDoc(tripRef, { events: updatedEvents });
            }
        } catch (error) {
            console.error("Error deleting event:", error);
        }
    }




// Reference to the invite-list div
const inviteListDiv = document.getElementById("invite-list");


// Function to fetch trip invites
async function fetchTripInvites() {
    try {

        const tripRef = doc(db, "Trips", tripId); // Reference to the specific trip document
        const invitesRef = collection(tripRef, "Invites"); // Subcollection reference
        const querySnapshot = await getDocs(invitesRef); // Fetch invites

        inviteListDiv.innerHTML = ""; // Clear previous content

        if (querySnapshot.empty) {
            inviteListDiv.innerHTML = "<p>No invites found.</p>";
            return;
        }

        querySnapshot.forEach((doc) => {
            const inviteData = doc.data();
            
            // Create an invite element
            const inviteItem = document.createElement("div");
            inviteItem.classList.add("invite-item");
            inviteItem.innerHTML = `
                <p><strong>${inviteData.name}</strong> - ${inviteData.email}</p>
            `;

            inviteListDiv.appendChild(inviteItem);
        });

    } catch (error) {
        console.error("Error fetching invites:", error);
        inviteListDiv.innerHTML = "<p>Error loading invites.</p>";
    }
}


// Fetch trip data and populate fields
async function loadTripData() {

    if (!tripId) {
        showToast("Invalid trip ID.");
        return;
    }

    try {
        console.log("loadTripData trip tripId: ",tripId);

        const tripRef = doc(db, "Trips", tripId);
 
        console.log("trip tripRef: ",tripRef);

        const tripSnap = await getDoc(tripRef);

        console.log("trip tripSnap: ",tripSnap);

        if (tripSnap.exists()) {
            const tripData = tripSnap.data();
         console.log("trip info: ",tripData);

            tripEditTitle.value = tripData.tripName || "";
            tripDescription.value = tripData.description || "";
            tripStartDate.value = tripData.startDate || "";
            tripEndDate.value = tripData.endDate || "";
            tripLocation.value = tripData.location || "";
            tripMapLink.value = tripData.mapLink || "";
            flightAirline.value = tripData.flightAirline || "";
            flightAirport.value = tripData.flightAirport || "";
            flightNumber.value = tripData.flightNumber || "";
            flightDeparture.value = tripData.flightDeparture || "";
            flightArrival.value = tripData.flightArrival || "";
            hotelName.value = tripData.hotelName || "";
            hotelCheckIn.value = tripData.hotelCheckIn || "";
            hotelCheckOut.value = tripData.hotelCheckOut || "";
            hotelBookingDetails.value = tripData.hotelBookingDetails || "";
            tripNotes.value = tripData.notes || "";
            enableVoting.checked = tripData.votingEnabled || false;

            tripTitle.innerText = tripData.tripName || "";
            tripDate.innerText = tripData.startDate || "";

            

            eventNameInput.value = tripData.eventName  || "";
            eventInfoInput.value = tripData.eventInfo || "";
            eventDateInput.value = tripData.eventDate || "";


            const events = tripData.events || [];
                eventList.innerHTML = ""; // Clear existing list

                events.forEach(event => addEventToList(event.name, event.date, event.info));
    

            const eventItem = document.createElement("li");
        eventItem.textContent = `${tripData.eventName} - ${tripData.eventDate} (${tripData.eventInfo || "No additional info"})`;

        eventList.appendChild(eventItem);


            // Load multiple flights
            flightsContainer.querySelectorAll(".flight-entry").forEach(el => el.remove());
            (tripData.flights || []).forEach(flight => addFlight(flight));

            // Load multiple hotels
            hotelsContainer.querySelectorAll(".hotel-entry").forEach(el => el.remove());
            (tripData.hotels || []).forEach(hotel => addHotel(hotel));


            // Show existing media preview if available
            if (tripData.coverPhoto) {
                mediaPreview.innerHTML = `<img src="${tripData.coverPhoto}" />`;
            }

            
            viewTripTitle.textContent = tripData.tripName || "";
    viewTripDescription.textContent = tripData.description || "";
    viewTripStartDate.textContent = tripData.startDate || "";
    viewTripEndDate.textContent = tripData.endDate || "";
    viewTripLocation.textContent = tripData.location || "";
    viewTripMapLink.href = tripData.mapLink || "#";
    viewTripMapLink.textContent = tripData.mapLink || "No Map Link";

    viewFlightAirline.textContent = tripData.flightAirline || "";
    viewFlightNumber.textContent = tripData.flightNumber || "";
    viewFlightDeparture.textContent = tripData.flightDeparture || "";
    viewFlightArrival.textContent = tripData.flightArrival || "";
    viewFlightAirport.textContent = tripData.flightAirport || "";

    viewHotelName.textContent = tripData.hotelName || "";
    viewHotelCheckIn.textContent = tripData.hotelCheckIn || "";
    viewHotelCheckOut.textContent = tripData.hotelCheckOut || "";
    viewHotelBookingDetails.textContent = tripData.hotelBookingDetails || "";

    viewTripNotes.textContent = tripData.notes || "";

    // Load multiple flights
    viewFlightsContainer.innerHTML = "";
    (tripData.flights || []).forEach(flight => addFlight(flight, viewFlightsContainer));

    // Load multiple hotels
    viewHotelsContainer.innerHTML = "";
    (tripData.hotels || []).forEach(hotel => addHotel(hotel, viewHotelsContainer));

    // Show existing media preview if available
    if (tripData.coverPhoto) {
        viewMediaPreview.innerHTML = `<img src="${tripData.coverPhoto}" alt="Trip Cover Photo" />`;
    }




            // Generate and display the join trip link
            const shareTripLink = `https://rw-501.github.io/tripapp/join/?id=${tripId}`;
            shareTripLinkText.value = shareTripLink;
            shareTripLinkContainer.style.display = "block";


            // Generate and display the join trip link
            const userId = auth.currentUser?.uid || "guest";
            const joinTripLink = `https://rw-501.github.io/tripapp/join/?id=${tripId}&u=${userId}`;
            joinTripLinkText.value = joinTripLink;
            joinTripLinkContainer.style.display = "block";



// Call function to load invites
fetchTripInvites();
loadPosts();

        } else {
            showToast("Trip not found.");
        }
    } catch (error) {
        console.error("Error fetching trip data:", error);
    }
}


// Handle media file preview
tripMedia.addEventListener("change", () => {
    const file = tripMedia.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = () => {
            mediaPreview.innerHTML = file.type.startsWith("video") ?
                `<video controls src="${reader.result}"></video>` :
                `<img src="${reader.result}" />`;
        };
        reader.readAsDataURL(file);
    }
});


// Copy link function
copyJoinLinkBtn.addEventListener("click", () => {
    joinTripLinkText.select();
    document.execCommand("copy");
    showToast("Join link copied!");
});




document.getElementById("saveTrip").addEventListener("click", async () => {

    if (!auth.currentUser) {
        showToast("Please log in to save changes.");
        return;
    }

    let mediaUrl = "";
    if (tripMedia.files.length > 0) {
        const file = tripMedia.files[0];
        const storageRef = ref(storage, `tripMedia/${tripId}/${file.name}`);
        await uploadBytes(storageRef, file);
        mediaUrl = await getDownloadURL(storageRef);
    }

    const flights = Array.from(document.querySelectorAll(".flight-entry")).map(flightDiv => ({
        airline: flightDiv.querySelector(".flightAirline").value,
        flightNumber: flightDiv.querySelector(".flightNumber").value,
        departure: flightDiv.querySelector(".flightDeparture").value,
        arrival: flightDiv.querySelector(".flightArrival").value
    }));

    const hotels = Array.from(document.querySelectorAll(".hotel-entry")).map(hotelDiv => ({
        name: hotelDiv.querySelector(".hotelName").value,
        checkIn: hotelDiv.querySelector(".hotelCheckIn").value,
        checkOut: hotelDiv.querySelector(".hotelCheckOut").value,
        details: hotelDiv.querySelector(".hotelBookingDetails").value
    }));

    const tripData = {
        tripName: tripTitle.value,
        description: tripDescription.value,
        coverPhoto: mediaUrl || null, // Keep previous image if no new upload
        updatedAt: serverTimestamp(),
        startDate: tripStartDate.value,
        endDate: tripEndDate.value,
        location: tripLocation.value,
        mapLink: tripMapLink.value,
        flights: flights,
        hotels: hotels,
        notes: tripNotes.value,
        votingEnabled: enableVoting.checked
    };

    try {
        const tripRef = doc(db, "Trips", tripId);
        await setDoc(tripRef, tripData, { merge: true });
        showToast("Trip details updated successfully!");
    } catch (error) {
        console.error("Error saving trip data:", error);
    }
});


window.showSection = function (sectionId) {
    document.querySelectorAll(".trip-section").forEach(section => {
        section.classList.add("hidden"); // Hide all sections
    });

    document.getElementById(sectionId).classList.remove("hidden"); // Show selected section

    document.querySelectorAll(".trip-tab").forEach(button => {
        button.classList.remove("active"); // Remove active class from all buttons
    });

    const activeButton = document.querySelector(`[id="btn${sectionId.split('_')[0].charAt(0).toUpperCase() + sectionId.split('_')[0].slice(1)}"]`);
    if (activeButton) {
        activeButton.classList.add("active"); // Add active class to selected button
    }
};
// Show/Hide Media Section
const mediaBtn = document.getElementById("media-btn");
const mediaSection = document.getElementById("media-container");
const mediaPreviewArea = document.getElementById("media-preview");

    const postMediaInput = document.getElementById("post-media");
    let selectedFiles = []; // Array to store the selected files

// Add event listeners to buttons
document.addEventListener("DOMContentLoaded", function () {
    const buttons = {
        btnView: "view_trip",
        btnItinerary: "view_itinerary",
        btnEdit: "edit_trip",
        btnSettings: "settings_trip",
        btnInvites: "invites_trip",
        btnContributors: "contributors_trip",
        btnMedia: "media_trip"
    };

    Object.entries(buttons).forEach(([btnId, sectionId]) => {
        document.getElementById(btnId).addEventListener("click", function () {
            showSection(sectionId);
        });
    });


mediaBtn.addEventListener("click", () => {
    // Trigger the file input click when the media button is clicked
   // mediaSection.style.display = "block";
    postMediaInput.click();
});


postMediaInput.addEventListener("change", (event) => {
    const files = event.target.files;

    // Add selected files to the array
    selectedFiles = [...selectedFiles, ...files];

    // Show the preview area when media is selected
    mediaPreviewArea.style.display = "flex";

    // Clear the previous previews
    mediaPreviewArea.innerHTML = "";

    // Loop through selected files and display previews
    for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        
        const reader = new FileReader();
        
        reader.onload = (e) => {
            const fileUrl = e.target.result;

            // Create a container for each preview (image/video)
            const previewContainer = document.createElement("div");
            previewContainer.classList.add("preview-container");

            if (file.type.startsWith("image/")) {
                // Display image preview
                const img = document.createElement("img");
                img.src = fileUrl;
                img.alt = "Image preview";
                previewContainer.appendChild(img);
            } else if (file.type.startsWith("video/")) {
                // Display video preview
                const video = document.createElement("video");
                video.src = fileUrl;
                video.controls = true;
                previewContainer.appendChild(video);
            }

            console.log("trip fileUrl: ",fileUrl);

            // Add remove button to each preview
            const removeBtn = document.createElement("button");
            removeBtn.classList.add("remove-btn");
            removeBtn.innerText = "X";
            removeBtn.onclick = () => removeMedia(previewContainer, file, i);
            previewContainer.appendChild(removeBtn);

            // Append the preview container to the preview area
            mediaPreviewArea.appendChild(previewContainer);
        };

        reader.readAsDataURL(file);
    }
});


destinationAutoSuggest("flightAirport"); 
airlineAutoSuggest(".flightAirline");
hotelAutoSuggest(".hotelName");

});


// Function to remove media
function removeMedia(previewContainer, file, index) {
    // Remove the preview container from the DOM
    previewContainer.remove();

    // Remove the file from the selectedFiles array
    selectedFiles.splice(index, 1);

    // If no files remain, hide the media preview area
    if (selectedFiles.length === 0) {
        mediaPreviewArea.style.display = "none";
        mediaSection.style.display = "none";
    } else {
        // Re-render the previews if there are remaining files
        mediaPreviewArea.innerHTML = "";
        selectedFiles.forEach((file, i) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const fileUrl = e.target.result;

                const previewContainer = document.createElement("div");
                previewContainer.classList.add("preview-container");

                if (file.type.startsWith("image/")) {
                    const img = document.createElement("img");
                    img.src = fileUrl;
                    img.alt = "Image preview";
                    previewContainer.appendChild(img);
                } else if (file.type.startsWith("video/")) {
                    const video = document.createElement("video");
                    video.src = fileUrl;
                    video.controls = true;
                    previewContainer.appendChild(video);
                }

                const removeBtn = document.createElement("button");
                removeBtn.classList.add("remove-btn");
                removeBtn.innerText = "X";
                removeBtn.onclick = () => removeMedia(previewContainer, file, i);
                previewContainer.appendChild(removeBtn);

                mediaPreviewArea.appendChild(previewContainer);
            };

            reader.readAsDataURL(file);
        });
    }
}

    // Add a post or poll
    async function addPost() {
    const content = document.getElementById("post-content").value.trim();
    const mediaInput = document.getElementById("post-media");
    const pollQuestion = document.getElementById("poll-question").value.trim();
    const pollOptions = [...document.querySelectorAll(".poll-option")]
        .map(input => input.value.trim())
        .filter(option => option); // Filter out empty poll options

    // Validate that either content or poll exists and media is selected if needed
    if (!(content || pollQuestion) && selectedFiles.length < 1) {
        return showToast("Please enter a post or poll!");
    }

    const postRef = doc(collection(db, "Trips", tripId, "Posts")); 

    let postData = {
        postId: postRef.id,
        content,
        createdBy: userId,
        timestamp: serverTimestamp(), // Firebase server timestamp
        votes: {},
        comments: [],
        pinned: false
    };

    // If poll exists, attach poll data
    if (pollQuestion) {
        postData.poll = {
            question: pollQuestion,
            options: pollOptions.map(option => ({ text: option, votes: 0 })),
            userVotes: {}
        };
    }

    // Handle media upload (if any)
    if (mediaInput.files.length > 0) {
        postData.mediaUrls = await uploadMedia(mediaInput.files); // Assume uploadMedia is implemented correctly
    }

    // Save the post data to Firestore
    await setDoc(postRef, postData);

    // Clear form fields after successful post
    document.getElementById("post-content").value = "";
    document.getElementById("poll-question").value = "";
    document.querySelectorAll(".poll-option").forEach(input => (input.value = ""));
    
    // Optionally, reset the media preview area
    mediaPreviewArea.innerHTML = ""; 
    //mediaSection.style.display = "none";

    selectedFiles = [];  // Reset selected files array
}


async function uploadMedia(files) { 
    const urls = [];
    for (let file of files) {
        const storageRef = ref(storage, `posts/${tripId}/${file.name}`);
        await uploadBytes(storageRef, file); // ✅ Corrected method
        urls.push(await getDownloadURL(storageRef));
    }
    return urls;
}


// Load posts
function loadPosts() {
          console.log("tripId:", tripId);
          const postList = document.getElementById("post-list");

// Create a query to fetch the posts collection and sort it
const postsQuery = query(
    collection(doc(db, "Trips", tripId), "Posts"), // Access Posts sub-collection
    orderBy("pinned", "desc"), // Sort by pinned first
    orderBy("timestamp", "desc") // Then by timestamp
);
//console.log("postsQuery:", postsQuery);

// Fetch the snapshot using the query
onSnapshot(postsQuery, (snapshot) => {
    postList.innerHTML = ""; // Clear existing posts
    snapshot.forEach((doc) => {
        const post = doc.data();
       // console.log("post:", post);

        postList.innerHTML += generatePostHTML(post); // Generate and append post HTML
    });
});
}


// Format timestamp into "time ago" format
function formatTimestamp(timestamp) {
    if (!timestamp) return "Just now";

    const now = new Date();
    const postDate = timestamp.toDate();
    const seconds = Math.floor((now - postDate) / 1000);

    if (seconds < 60) return `${seconds} sec${seconds === 1 ? "" : "s"} ago`;
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return `${minutes} min${minutes === 1 ? "" : "s"} ago`;
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return `${hours} hour${hours === 1 ? "" : "s"} ago`;
    const days = Math.floor(hours / 24);
    if (days < 7) return `${days} day${days === 1 ? "" : "s"} ago`;
    const weeks = Math.floor(days / 7);
    if (weeks < 4) return `${weeks} week${weeks === 1 ? "" : "s"} ago`;
    const months = Math.floor(days / 30);
    if (months < 12) return `${months} month${months === 1 ? "" : "s"} ago`;
    const years = Math.floor(days / 365);
    
    return `${years} year${years === 1 ? "" : "s"} ago`;
}


let images = [];
let currentImageIndex = 0;



// Function to create a collage
function createCollage(mediaUrls) {
    // Shuffle the mediaUrls array to randomize the order
    const shuffledImages = shuffleArray([...mediaUrls]);

    // Show up to 3 images
    const imagesToShow = shuffledImages.slice(0, 3);
    
    const collageHTML = imagesToShow.map((url, index) => `
        <img src="${url}" class="collage-image" onclick='openImageViewer("${index}", "${shuffledImages}")'>
    `).join("");

    // If there are more than 3 images, show the "View Others" button
    const viewOthersButton = shuffledImages.length > 3 ? `
        <div class="view-others">
            <button class="view-others-btn" onclick='openImageViewer(0, "${shuffledImages}")'>More</button>
        </div>
    ` : "";

    return `
        <div class="collage-container">
            ${collageHTML}
            ${viewOthersButton}
        </div>
    `;
}

// Function to open the image viewer
function openImageViewer(index, mediaUrls) {
    if (!Array.isArray(mediaUrls) || mediaUrls.length === 0) {
        console.error("Invalid media URLs provided.");
        return;
    }

    if (index < 0 || index >= mediaUrls.length) {
        console.error("Index out of bounds.");
        return;
    }

    images = mediaUrls;
    currentImageIndex = index;

    const viewerImage = document.getElementById("viewerImage");
    const imageViewer = document.getElementById("imageViewer");

    // Apply fade-out before changing the image
    viewerImage.style.opacity = 0;

    setTimeout(() => {
        viewerImage.src = images[currentImageIndex];
        viewerImage.style.opacity = 1;
    }, 200); // Smooth transition effect

    imageViewer.style.display = "flex";
}

// Function to close the image viewer
function closeImageViewer() {
    document.getElementById("imageViewer").style.display = "none";
}

// Function to go to the next image
function nextImage() {
    if (currentImageIndex < images.length - 1) {
        currentImageIndex++;
        document.getElementById("viewerImage").src = images[currentImageIndex];
    }
}

// Function to go to the previous image
function prevImage() {
    if (currentImageIndex > 0) {
        currentImageIndex--;
        document.getElementById("viewerImage").src = images[currentImageIndex];
    }
}

// Make functions globally accessible
window.openImageViewer = openImageViewer;
window.closeImageViewer = closeImageViewer;
window.nextImage = nextImage;
window.prevImage = prevImage;

const imageViewer = document.getElementById("imageViewer");
    const viewerImage = document.getElementById("viewerImage");
    const closeBtn = document.getElementById("closeBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");

closeBtn.addEventListener("click", closeImageViewer);
    prevBtn.addEventListener("click", prevImage);
    nextBtn.addEventListener("click", nextImage);

// Function to shuffle an array (Fisher-Yates shuffle)
function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]]; // Swap elements
    }
    return array;
}



    // Keyboard Navigation
    document.addEventListener("keydown", function(event) {
        if (imageViewer.style.display === "flex") {
            if (event.key === "ArrowRight") nextImage();
            if (event.key === "ArrowLeft") prevImage();
            if (event.key === "Escape") closeImageViewer();
        }
    });

    // Click outside image to close
    imageViewer.addEventListener("click", function(event) {
        if (event.target === imageViewer) {
            closeImageViewer();
        }
    });


// Updated generatePostHTML function
function generatePostHTML(post) {
    let pollHTML = "";
    if (post.poll) {
        pollHTML = `
            <div class="poll">
                <p><strong>${post.poll.question}</strong></p>
                ${post.poll.options.map((option, index) => `
                    <button class="poll-option" onclick="votePoll('${post.postId}', ${index})">
                        ${option.text} (${option.votes} votes)
                    </button>
                `).join("")}
            </div>
        `;
    }

    return `
        <div class="post ${post.pinned ? 'pinned' : ''}" id="post-${post.postId}">
            <p><strong>${post.content}</strong></p>
            <p class="timestamp">${formatTimestamp(post.timestamp)}</p>
            
            <!-- Collage of images if mediaUrls exist -->
            ${post.mediaUrls ? createCollage(post.mediaUrls) : ""}
            
            ${pollHTML}
            <div class="post-controls">
                <button class="vote-btn ${post.votes[userId] === 1 ? "upvoted" : ""}" 
                        onclick="votePost('${post.postId}', 1)">👍</button>
                <button class="vote-btn ${post.votes[userId] === -1 ? "downvoted" : ""}" 
                        onclick="votePost('${post.postId}', -1)">👎</button>
                ${post.createdBy === userId ? `
                    <button class="edit-btn" onclick="editPost('${post.postId}', '${post.content}')">✏️ Edit</button>
                    <button class="pin-btn" onclick="togglePinPost('${post.postId}', ${post.pinned})">
                        📌 ${post.pinned ? "Unpin" : "Pin"}
                    </button>
                    <button class="delete-btn" onclick="deletePost('${post.postId}')">🗑️ Delete</button>
                ` : ""}
            </div>
            <div class="comments-section">
                <input type="text" class="comment-input" placeholder="Write a comment..." onkeypress="addComment(event, '${post.postId}')">
                <div class="comments-list">
                    ${post.comments.map(comment => `
                        <p><strong>${comment.user}</strong>: ${comment.text} (${formatTimestamp(comment.timestamp)})</p>
                    `).join("")}
                </div>
            </div>
        </div>
    `;
}

async function togglePinPost(postId, isPinned) {
    const postRef = db.collection("Trips").doc(tripId).collection("Posts").doc(postId);
    await postRef.update({ pinned: !isPinned });
}

// Edit a post
async function editPost(postId, currentContent) {
    const newContent = prompt("Edit your post:", currentContent);
    if (newContent && newContent.trim() !== "") {
        await db.collection("Trips").doc(tripId).collection("Posts").doc(postId).update({ content: newContent });
    }
}

// Delete a post
async function deletePost(postId) {
    if (!confirm("Are you sure you want to delete this post?")) return;
    await db.collection("Trips").doc(tripId).collection("Posts").doc(postId).delete();
}

// Vote on a post
async function votePost(postId, value) {
    const postRef = db.collection("Trips").doc(tripId).collection("Posts").doc(postId);
    const postSnap = await postRef.get();
    if (!postSnap.exists) return;

    let votes = postSnap.data().votes || {};
    if (votes[userId] === value) {
        delete votes[userId]; // Remove vote if clicking again
    } else {
        votes[userId] = value;
    }

    await postRef.update({ votes });
}

// Vote on a poll
async function votePoll(postId, optionIndex) {
    const postRef = db.collection("Trips").doc(tripId).collection("Posts").doc(postId);
    const postSnap = await postRef.get();
    if (!postSnap.exists) return;

    let poll = postSnap.data().poll;
    if (!poll) return;

    if (poll.userVotes[userId] !== undefined) {
        showToast("You already voted on this poll!");
        return;
    }

    poll.options[optionIndex].votes += 1;
    poll.userVotes[userId] = optionIndex;

    await postRef.update({ poll });
}

// Add a comment
async function addComment(event, postId) {
    if (event.key !== "Enter") return;
    const commentInput = event.target;
    const commentText = commentInput.value.trim();

    if (!commentText) return;

    const postRef = db.collection("Trips").doc(tripId).collection("Posts").doc(postId);
    const postSnap = await postRef.get();
    if (!postSnap.exists) return;

    let comments = postSnap.data().comments || [];
    comments.push({ user: userId, text: commentText, timestamp: firebase.firestore.FieldValue.serverTimestamp() });

    await postRef.update({ comments });

    commentInput.value = "";
}




// Event Listeners
document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("addPost").addEventListener("click", addPost);
    document.getElementById("addPollOption").addEventListener("click", addPollOption);




    showSection("view_trip"); // Show default section on load



// Check if user is authenticated
onAuthStateChanged(auth, (user) => {
    if (user) {
        console.log("User is authenticated:", user.uid);
        loadTripData(); // Load data if user is logged in
    } else {
        console.error("User is not authenticated");
    }
});


});



    </script>
</body>
</html>
